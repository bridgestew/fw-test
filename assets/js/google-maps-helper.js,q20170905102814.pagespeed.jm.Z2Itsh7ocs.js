function createMarker(lat,lon,index){if(lat&&lon&&map){var latLng=new google.maps.LatLng(parseFloat(lat),parseFloat(lon));var marker=new google.maps.Marker({map:map,position:latLng,icon:"//chart.googleapis.com/chart?chst=d_map_pin_letter&chld="+(index+1)+"|333333|ffffff"});google.maps.event.addListener(marker,'click',function(){location.hash="#Result"+(index+1)});markers.push(marker);map.fitBounds(latLngBounds.extend(latLng));}}
function clearLocations(){$('#search-results').empty();for(var n=0;n<markers.length;n++)
markers[n].setMap(null);markers.length=0;latLngBounds=new google.maps.LatLngBounds;}
function clearRepresentatives(){var localRepElement=$('#local-rep');localRepElement.find('.name').html('');localRepElement.find('.email').html('');localRepElement.find('.phone').html('');localRepElement.find('.website').html('');}
function updateMapCenter(lat,lon){if(lat&&lon){if(!map){initializeMap(lat,lon,$('#map'));}
if(map)
map.setCenter(new google.maps.LatLng(parseFloat(lat),parseFloat(lon)));}}
function getLocations(event){event.preventDefault();var addressInput=$('#address').val(),countryName=$('#countryName').val();if(addressInput){if(countryName&&countryName!==''){addressInput+=','+countryName;}
geocoder.geocode({address:addressInput,region:$('#countryCode').val()},function(results,status){var searchForm=$('#find-retailer-location-form');if(status==google.maps.GeocoderStatus.OK){var coords=results[0].geometry.location;populateFormFields(coords.lat(),coords.lng(),results[0].address_components);}
var url=searchForm.attr("action");$.post(url,searchForm.serialize(),function(response){clearLocations();clearRepresentatives();$('.error').hide();var locationResults='';if(response.locations){$('.results-container').show();updateMapCenter(response.searchLat,response.searchLon);$.each(response.locations,function(i,e){createMarker(e.latitude,e.longitude,i);locationResults+=e.name+' - '+e.postalCode+((i+1==response.locations.length)?'':'| ');var html='<div id="Result'+(i+1)+'" class="g-row separator--above">';if($('#searchType').val()=='retailer'){html+='<div class="g-col  g-lap-and-up--1-4  mbm">';}else{html+='<div class="g-col  g-lap-and-up--1-3  mbm">';}
html+='<div class="g-row  mbn"><div class="g-col g-lap-and-up--1-8"><span class="number map-pin"><img src="//chart.googleapis.com/chart?chst=d_map_pin_letter&chld='+(i+1)+'|333333|ffffff"></span></div><div class="g-col g-lap-and-up--7-8"><h3>'+response.locationLabel+'</h3><div>'+e.name+'</div>'+'<div>'+e.address1+'</div>';if(e.address2)
html+='<div>'+e.address2+'</div>';if(e.address3)
html+='<div>'+e.address3+'</div>';html+='<div>'+e.city+', '+e.state+((e.postalCode)?' '+e.postalCode:'')+'</div>'+'<div>'+e.phoneNumber+'</div>'+((e.website!=null)?'<div><a href="'+e.website+'" target="_blank">'+e.linkText+'</a></div>':'')+'<div>'+getDirectionUrl(e,response.directionsLabel)+'</div></div>'+'</div></div><div class="g-col g-lap-and-up--1-6  mbm"><h3>'+response.distanceLabel+'</h3><div>'+Math.round(e.distance*10)/10+' '+response.unitsLabel+'</div></div>';if($('#searchType').val()=='retailer'){html+='<div class="g-col g-lap-and-up--1-4  mbm"><h3>'+response.productsLabel+'</h3><div>'+((e.products)?buildProducts(e.products):'')+'</div></div><div class="g-col g-lap-and-up--1-8  mbm"><h3>'+response.storeLabel+'</h3><div>'+((e.locationType=='store')?'<img src="'+hostName+'/img/result-check.png" />':'')+'</div></div><div class="g-col g-lap-and-up--1-5  mbm"><h3>'+response.demoLabel+'</h3>'+((e.events&&e.events.length>0)?buildEvents(e.events):'')+'</div></div>';}
html+='</div>';$('#search-results').append(html);});}else{$('.results-container').hide();}
var searchResultsTitle=$('#search-results-title');searchResultsTitle.html('');if(response.resultsMessage){searchResultsTitle.html(response.resultsMessage);}
var localRepList=$('#local-rep-list');if(localRepList){if(response.localReps){$('.local-rep').empty();var localRepListHeader=$('.local-rep-list-header');localRepListHeader.empty();localRepList.removeClass('hidden');var showPhone=false;var showEmail=false;var showWebsite=false;$(response.localReps).each(function(i,e){showPhone=showPhone||!!e.phoneNumber;showEmail=showEmail||!!e.emailAddress;showWebsite=showWebsite||!!e.website;});var columnWidth=1+(showEmail?1:0)+(showWebsite?1:0)+(showPhone?1:0)
$(response.localReps).each(function(i,e){var rep='<div id="local-rep" class="local-rep g-row"><div class="g-col g-1-'+columnWidth+' mbm">'+e.name+'</div>';if(showPhone){rep+='<div class="g-col g-1-'+columnWidth+' mbm">'+e.phoneNumber+'</div>';}
if(showEmail){rep+='<div class="g-col g-1-'+columnWidth+' mbm">'+e.emailAddress+'</div>';}
if(showWebsite){rep+='<div class="g-col g-1-'+columnWidth+' mbm">';if(e.website){rep+='<a href="'+e.website+'" target="_blank">'+(e.linkText?e.linkText:e.website)+'</a>';}
rep+='</div>';}
rep+='</div>';localRepList.append(rep);});var repHeader='';function addRepHeader(condition,index){if(condition){repHeader+='<div class="g-col g-1-'+columnWidth+'"><h3>'+response.localRepHeaders[index]+'</h3></div>';}}
addRepHeader(true,0);addRepHeader(showPhone,1);addRepHeader(showEmail,2);addRepHeader(showWebsite,3);localRepListHeader.html(repHeader);}else{localRepList.addClass('hidden');}}
var searchTypeInput=$('#searchType').val();sendOmnitureSearchComplete(searchTypeInput,locationResults);},'json').fail(function(response){});});}else{$('#zipError').show();}}
function sendOmnitureSearchComplete(searchType,locationResults){var searchTypeEvent='event25';var eventType='list2,eVar23,eVar14';if(searchType=='dealer'){searchTypeEvent='event26';eventType='list2,eVar23';}
var s=s_gi(omnitureSiteId);s.linkTrackVars=eventType;s.linkTrackEvents=searchTypeEvent;s.events=searchTypeEvent;s.eVar23=$('input[id*=address]').val();s.eVar14=$('select[id*=productFamily] option:selected').text();s.list2=locationResults;s.tl(true,'o',searchType+'-search',null,'navigate');}
function buildProducts(products){var productsList='';$.each(products,function(i,e){productsList+='<div>'+e.name+'</div>';});return productsList;}
function buildEvents(events){var eventHtml='<div><img src="'+hostName+'/img/result-check.png" /></div>';$.each(events,function(i,e){eventHtml+='<div><div>'+e.name+'</div><div>'+e.startDate+'-'+e.endDate+'</div><div>'+e.notes+'</div></div>';});return eventHtml;}
function getDirectionUrl(location,linkText){var addressString=location.address1;if(location.address2&&location.address2!='')
addressString+='+'+location.address2;if(location.address3&&location.address3!='')
addressString+='+'+location.address3;if(location.city&&location.city!='')
addressString+=',+'+location.city;if(location.state&&location.state!='')
addressString+=',+'+location.state;if(location.postalCode&&location.postalCode!='')
addressString+=',+'+location.postalCode;return'<a class="omni-dealer-directions-link" href="http://maps.google.com/maps?daddr='+addressString+'" target="_blank" data-location-name="'+location.name+'">'+((linkText)?linkText:'Directions')+'</a>';}
function mapSetup(mapDefault,pOmnitureSiteId){var mapElement=document.getElementById('map');var addressElement=$('#address');omnitureSiteId='vitamix'+pOmnitureSiteId;if(mapElement&&addressElement){var defaultMapAddress=(addressElement.val()!='')?addressElement.val():mapDefault;var countryCodeElement=$('#countryCode');var addressFilter={address:defaultMapAddress};if(countryCodeElement&&countryCodeElement.val()!=''){addressFilter['region']=countryCodeElement.val();}
geocoder=new google.maps.Geocoder();geocoder.geocode(addressFilter,function(results,status){if(status==google.maps.GeocoderStatus.OK){var coords=results[0].geometry.location;initializeMap(coords.lat(),coords.lng(),mapElement);populateFormFields(coords.lat(),coords.lng(),results[0].address_components);if(document.location.port!="")
port=":"+document.location.port;hostName=document.location.protocol+"//"+document.location.hostname+port;latLngBounds=new google.maps.LatLngBounds();}else{$('#map').html('map unavailable');}});}}
function populateFormFields(lat,lon,addressComponents){var coordElement=$('#latitude');if(coordElement&&lat)
coordElement.val(lat);coordElement=$('#longitude');if(coordElement&&lon)
coordElement.val(lon);if(addressComponents){var city;$(addressComponents).each(function(i,e){$(e.types).each(function(i1,e1){if(e1=='postal_code'){$('#address').val(e.short_name);$('#postalCode').val(e.short_name);}else if(e1=='locality'){$('#city').val(e.long_name);city=e.long_name;}else if(e1=='administrative_area_level_1'){$('#state').val(e.short_name);}else if(e1=='country'){$('#countryName').val(e.long_name);}});});if($('#countryCode').val()==='IE'&&city){$('#address').val(city);$('#postalCode').val(city);}}}
function initializeMap(lat,lon,mapElement){var mapParams={center:new google.maps.LatLng(((lat)?lat:41.557337),((lon)?lon:-81.530233)),zoom:10,zoomControl:!0,mapTypeControl:!1,scaleControl:!1,streetViewControl:!1,mapTypeId:google.maps.MapTypeId.ROADMAP};map=new google.maps.Map(mapElement,mapParams);}
var geocoder,map,markers=[],hostName="",port="",address,latLngBounds,omnitureSiteId;